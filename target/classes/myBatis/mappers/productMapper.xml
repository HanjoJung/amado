<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="productMapper">
	<select id="seqNext" resultType="java.lang.Integer">
		select product_seq.nextval from dual
	</select>

	<select id="getCount" parameterType="Pager" resultType="java.lang.Integer">
		select count(productNum) from product
		where 
			<if test="brand  != null"> brand in 
				<foreach collection="brand" item="brand" open="(" close=")" separator=",">#{brand}</foreach> AND 
			</if>
			(productCode like '%'||#{search}||'%' or productName like '%'||#{search}||'%') 
			<if test="kind != null and kind != ''">and kind = #{kind} </if>
			and price between #{minPrice} and #{maxPrice}
	</select>
	
	<select id="list" parameterType="Pager" resultType="ProductDTO">
		select * from
			(select ROWNUM R, p.* from
				(select productNum, productCode, productName, price, kind, score, good, reg_date from 
					(select * from product 
					where price between #{minPrice} and #{maxPrice}
					and
					<if test="brand  != null and brand  != ''"> brand in 
						<foreach collection="brand" item="brand" open="(" close=")" separator=",">#{brand}</foreach> AND 
					</if>
					(productCode like '%'||#{search}||'%' or productName like '%'||#{search}||'%') 
					<if test="kind != null and kind != ''">and kind = #{kind} </if>
					)
					left join 
					(select avg(score)*20 score, productNum from review group by productNum)
					using (productNum)
					order by 
					<choose>
						<when test="sort == 'priceAsc'"> price asc, </when>
						<when test="sort == 'priceDesc'"> price desc, </when>
						<when test="sort == 'score'"> score desc NULLS LAST, </when>
					</choose>
					reg_date desc
				) p 
			)
		where R between #{startRow} and #{lastRow}
	</select>
	
	<select id="selectOne" parameterType="java.lang.Integer" resultType="ProductDTO">
		select * from (select * from product)
		left join 
		(select avg(score)*20 score, productNum from review group by productNum)
		using (productNum)
		where productNum = #{productNum}
	</select>
	
	<insert id="insert" parameterType="ProductDTO">
		insert into product 
		values(#{productNum}, #{productName}, #{price}, #{kind}, #{contents}, 0, 0, 0, #{brand}, #{stock}, sysdate, #{productCode})
	</insert>
	
	<update id="update" parameterType="ProductDTO">
		update product
		<set>
	  		<if test="productName != null and productName != ''"> productName = #{productName},</if> 
	  		<if test="productCode != null and productCode != ''"> productCode = #{productCode},</if> 
	  		<if test="kind != null and kind != ''"> kind = #{kind},</if>
	  		<if test="contents != null and contents != ''"> contents = #{contents},</if>
	  		<if test="brand != null and brand != ''"> brand = #{brand},</if>
	  		<if test="price != null"> price = #{price},</if>
	  		<if test="hit != null"> hit = #{hit},</if>
	  		<if test="sale != null"> sale = #{sale},</if>
	  		<if test="good != null"> good = #{good},</if>
	  		<if test="stock != null"> stock = #{stock}</if> 
		</set>
		where productNum = #{productNum}
	</update>
	
	<delete id="delete">
		delete product 
		where productNum = #{productNum}
	</delete>
	
</mapper>